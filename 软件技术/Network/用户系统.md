> 参考：
>
> - https://sherryhsu.medium.com/session-vs-token-based-authentication-11a6c5ac45e4
> - https://jwt.io/introduction
> - https://stackoverflow.com/questions/43452896/authentication-jwt-usage-vs-session
> - https://en.wikipedia.org/wiki/OAuth

# 用户系统

## Session Base Authentication

### 流程简介

最传统的用户系统，django 的默认实现，用户登陆时后服务端会为当前会话创建一个 `session` 并且将 `sessionID` 作为 cookie 设置到客户端上，用户每次需要访问敏感资源时需要带上 `sessionID`，服务端通过 session 判断用户是否登陆成功。简单流程如下：

![session_base_authentication](./session_base_authentication.png)

## JWT (Json Web Token)

### 格式

JWT 是一种被写入 [RFC7519](https://datatracker.ietf.org/doc/html/rfc7519) 的协议标准。一个 JWT 的格式由 Base64 加密的 “Header”、“Payload”、“Signature” 三个部分由 `.` 字符拼接而成：

![jwt_format](./jwt_format.png)

上图中可以看出三部分的作用：

1. `header` 部分表示当前 JWT 的算法；
2. `playload` 则存储了当前登陆用户的信息（在传统基于 `session` 的登陆系统下，这一信息一般是存储在服务端），`Playload` 分为 `Registered claims`/`Public claims`/`Private claims` 三个类型；
3. `signature` 用服务端的私钥进行 HMAC 确保 `playload` 中的信息没有被修改过；

### 工作流

在认证成功后，服务器会返回给客户端一个 JWT。当客户端需要访问任何敏感资源时，需要设置 `Authorization` 的请求头：

```
Authorization: Bearer <token>
```

图例：

![jwt_authentication](./jwt_authentication.png)

值得注意的是，因为 Token 是在请求头的 `Authorization` 中带上的，所以并不会被浏览器的跨域策略（CORS, Cross-Origin Resource Sharing）影响。**Token 不是 Cookie**。

### 优点与缺点

 JWT(Json Web Token) 相对 SWT(Simple Web Token) 与 SMAL(Security Assertion Markup Language Tokens) 的好处：

- JWT 相对于 SMAL 有更小的体积，相对于解析 xml 解析 json 更加简单，更适合在 http 协议于 html 文件的场景下进行传输；
- JWT 相对于 SWT 更加安全。SWT 只能解析基于共享密钥的对称加密算法，而 JWT（SMAL 也支持）则支持 `X.509` 格式的公私钥签名；

相比传统使用 `sessionID` 的 cookie 进行身份校验的好处：

1. Scalability（可扩展性）：传统的 `sessionID` 策略如果将用户信息持久化存储在数据库中，每次请求数据库都会执行一次数据库查询；如果存储在内存中则存在分布式系统的横向扩展问题。jwt 将信息存储在客户端，并且服务端做鉴权，就不存在这个问题；
2. Multiple Devices：可以用于设计 SSO 单点登录系统，因为 JWT Token 被设置在 http 请求头中，可以规避浏览器跨域问题；

JWT 也有一些缺点，在 RFC 的标准协议中没有指定解决方案：

- 客户端存储信息的安全性、JWT 信息传输的安全性、JWT Token 难以被控制失效、客户端信息信任问题；

### nodejs 生态

[jsonwebtoken](https://www.npmjs.com/package/jsonwebtoken) 可以用于在服务端创建一个 JWT，[express-jwt](https://github.com/auth0/express-jwt) 中间件可以用于对 jwt 进行鉴权。

## OAuth (Open Authorization)

OAuth 是一种第三方授权协议，现在讨论的版本通常是 OAuth2.0，也是 RFC 的标准协议 [RFC6749](https://datatracker.ietf.org/doc/html/rfc6749)。

OAuth 的大致工作流程在 RFC 的文档中有详细解释：

```
     +--------+                               +---------------+
     |        |--(A)- Authorization Request ->|   Resource    |
     |        |                               |     Owner     |
     |        |<-(B)-- Authorization Grant ---|               |
     |        |                               +---------------+
     |        |
     |        |                               +---------------+
     |        |--(C)-- Authorization Grant -->| Authorization |
     | Client |                               |     Server    |
     |        |<-(D)----- Access Token -------|               |
     |        |                               +---------------+
     |        |
     |        |                               +---------------+
     |        |--(E)----- Access Token ------>|    Resource   |
     |        |                               |     Server    |
     |        |<-(F)--- Protected Resource ---|               |
     +--------+                               +---------------+
```

在标准文档更关于不同授权模式的介绍，不详细赘述。

值得注意的是 OAuth 与 JWT 并不是并列的关系，OAuth 中的 Access Token 可以用 JWT 实现，它们应该是一个嵌套的关系。

## OIDC (OpenID Connection)

OIDC 是一个基于 OAuth2.0 的身份认证协议，